//package com.bytefinger.toutuo.biz.performance.service.impl;////import com.baomidou.mybatisplus.core.toolkit.Wrappers;//import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;//import com.bytefinger.common.core.utils.StringUtils;//import com.bytefinger.common.security.utils.SysConfigUtils;//import com.bytefinger.toutuo.biz.performance.domain.ActualOutMonth;//import com.bytefinger.toutuo.biz.performance.domain.ActualOutYear;//import com.bytefinger.toutuo.biz.performance.domain.BO.PerformanceBO;//import com.bytefinger.toutuo.biz.performance.domain.dto.PerformanceDTO;//import com.bytefinger.toutuo.biz.performance.domain.template.PerformanceTemplate;//import com.bytefinger.toutuo.biz.performance.domain.vo.PerformanceVO;//import com.bytefinger.toutuo.biz.performance.domain.vo.PerformanceValue;//import com.bytefinger.toutuo.biz.performance.manager.PerformanceManager;//import com.bytefinger.toutuo.biz.performance.mapper.ActualOutMonthMapper;//import com.bytefinger.toutuo.biz.performance.mapper.ActualOutYearMapper;//import com.bytefinger.toutuo.biz.performance.service.IActualInService;//import com.bytefinger.toutuo.biz.performance.service.IActualOutService;//import lombok.AllArgsConstructor;//import org.springframework.stereotype.Service;////import java.math.BigDecimal;//import java.util.Collections;//import java.util.List;//import java.util.Map;//import java.util.stream.Collectors;/////**// * <p>// * 实际支出// * </p>// *// * @author patrick// * @since 2022-11-27// *///@Service//@AllArgsConstructor//public class ActualOutServiceImpl extends ServiceImpl<ActualOutYearMapper, ActualOutYear> implements IActualOutService {////    private final PerformanceManager budgetManager;////    private final ActualOutYearMapper actualOutYearMapper;////    private final ActualOutMonthMapper actualOutMonthMapper;////    private final IActualInService actualInService;////    /**//     * 实际支出//     *///    private static final String BIZ_ACTUAL_OUT = "BIZ_ACTUAL_OUT";////    /**//     * 实际支出-总部利润计提//     *///    private static final String[] BIZ_ACTUAL_OUT_PROPORTION = {"ZBLRJT"};////    /**//     * 全年实际支出提示//     *///    private static final String BIZ_ACTUAL_OUT_MESSAGE = "BIZ_ACTUAL_OUT_MESSAGE";////    /**//     * 实际支出前缀key//     *///    private static final String BIZ_ACTUAL_OUT_START_KEY = "BIZ_ACTUAL_OUT_";//////    @Override//    public PerformanceVO getOrUpdate(Integer level, Long recordId, Integer currYear, PerformanceDTO budgetDTO) {//        List<PerformanceTemplate> budgetTemplates = budgetManager.getTemplate(BIZ_ACTUAL_OUT);////        // 年数据//        List<ActualOutYear> dataList = this.list(Wrappers.<ActualOutYear>lambdaQuery()//                .eq(ActualOutYear::getRecordId, recordId)//                .eq(ActualOutYear::getFieldYear, currYear)//                .in(ActualOutYear::getFieldKey, budgetTemplates.stream().map(PerformanceTemplate::getFieldKey).collect(Collectors.toList())));////        // 月数据//        List<ActualOutMonth> monthDatas = actualOutMonthMapper.selectList(Wrappers.<ActualOutMonth>lambdaQuery()//                .eq(ActualOutMonth::getRecordId, recordId)//                .eq(ActualOutMonth::getFieldYear, currYear)//                .in(ActualOutMonth::getFieldKey, budgetTemplates.stream().map(PerformanceTemplate::getFieldKey).collect(Collectors.toList())));////        // 实际收入//        Map<String, BigDecimal> actualInByYear = actualInService.getActualInByYear(recordId, level, currYear);////        PerformanceBO budgetBO = new PerformanceBO();//        budgetBO.setBudgetKey(BIZ_ACTUAL_OUT);//        budgetBO.setYears(Collections.unmodifiableList(dataList));//        budgetBO.setMonths(Collections.unmodifiableList(monthDatas));//        budgetBO.setYMapper(actualOutYearMapper);//        budgetBO.setMMapper(actualOutMonthMapper);//        budgetBO.setLevel(level);//        budgetBO.setRecordId(recordId);//        budgetBO.setCurrYear(currYear);//        budgetBO.setBudgetDTO(budgetDTO);//        budgetBO.setModelName("ActualOut");//        budgetBO.setBudgetYear(ActualOutYear.class);//        budgetBO.setBudgetMonth(ActualOutMonth.class);//        PerformanceVO performanceVO = budgetManager.getOrUpdate(budgetBO);//////        performanceVO.getBudgetDatas().stream().forEach(item -> {//            for (String outKey : BIZ_ACTUAL_OUT_PROPORTION) {//                if (item.getKey().equals(outKey)) {//                    String tmp = SysConfigUtils.getConfigCache(BIZ_ACTUAL_OUT_START_KEY + outKey);//                    if (StringUtils.isNotEmpty(tmp)) {//                        BigDecimal bigDecimal = new BigDecimal(tmp);//                        item.setReadonly(true);//                        item.setValue(BigDecimal.ZERO);//                        for (String key : item.getList().keySet()) {//                            PerformanceValue performanceValue = item.getList().get(key);//                            BigDecimal bvalue = actualInByYear.get(key);//                            bvalue = (null == bvalue) ? BigDecimal.ZERO : bvalue.multiply(bigDecimal).divide(new BigDecimal(100));//                            performanceValue.setValue(bvalue);//                            performanceValue.setReadonly(true);//                            item.setValue(item.getValue().add(bvalue));//                        }//                    }//                }//            }//        });////        return performanceVO;//    }////    @Override//    public String note() {//        String messge = SysConfigUtils.getConfigCache(BIZ_ACTUAL_OUT_MESSAGE);//        if (StringUtils.isNotEmpty(messge)) {//            for (String outKey : BIZ_ACTUAL_OUT_PROPORTION) {//                String tmp = SysConfigUtils.getConfigCache(BIZ_ACTUAL_OUT_START_KEY + outKey);//                if (StringUtils.isNotEmpty(tmp)) {//                    messge = messge.replace("{" + BIZ_ACTUAL_OUT_START_KEY + outKey + "}", tmp);//                }//            }//        }//        return messge;//    }////}
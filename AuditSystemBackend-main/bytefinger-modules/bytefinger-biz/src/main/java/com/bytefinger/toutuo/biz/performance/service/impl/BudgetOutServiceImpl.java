//package com.bytefinger.toutuo.biz.performance.service.impl;////import cn.hutool.core.collection.CollUtil;//import cn.hutool.core.util.ArrayUtil;//import com.alibaba.fastjson2.JSON;//import com.baomidou.mybatisplus.core.toolkit.Wrappers;//import com.bytefinger.common.core.exception.ServiceException;//import com.bytefinger.common.core.utils.StringUtils;//import com.bytefinger.common.security.utils.SysConfigUtils;//import com.bytefinger.toutuo.biz.performance.domain.BO.PerformanceBO;//import com.bytefinger.toutuo.biz.performance.domain.BO.PerformanceList;//import com.bytefinger.toutuo.biz.performance.domain.BO.PerformanceMonth;//import com.bytefinger.toutuo.biz.performance.domain.BudgetInMonth;//import com.bytefinger.toutuo.biz.performance.domain.BudgetInYear;//import com.bytefinger.toutuo.biz.performance.domain.BudgetOutMonth;//import com.bytefinger.toutuo.biz.performance.domain.BudgetOutYear;//import com.bytefinger.toutuo.biz.performance.domain.dto.PerformanceDTO;//import com.bytefinger.toutuo.biz.performance.domain.template.BudgetOutRulesTemplate;//import com.bytefinger.toutuo.biz.performance.domain.template.PerformanceTemplate;//import com.bytefinger.toutuo.biz.performance.domain.vo.PerformanceVO;//import com.bytefinger.toutuo.biz.performance.domain.vo.PerformanceValue;//import com.bytefinger.toutuo.biz.performance.manager.PerformanceManager;//import com.bytefinger.toutuo.biz.performance.mapper.*;//import com.bytefinger.toutuo.biz.performance.service.IBudgetOutService;//import com.google.common.collect.Maps;//import lombok.AllArgsConstructor;//import org.springframework.stereotype.Service;////import java.math.BigDecimal;//import java.util.Collections;//import java.util.List;//import java.util.Map;//import java.util.stream.Collectors;/////**// * <p>// * 预算支出// * </p>// *// * @author patrick// * @since 2022-11-27// *///@Service//@AllArgsConstructor//public class BudgetOutServiceImpl implements IBudgetOutService {////    private final PerformanceManager budgetManager;////    private final BudgetOutYearMapper budgetOutYearMapper;////    private final BudgetOutMonthMapper budgetOutMonthMapper;////    private final PerformanceMapper budgetMapper;////    private final BudgetInYearMapper budgetInYearMapper;////    private final BudgetInMonthMapper budgetInMonthMapper;////    /**//     * 预算支出-判断其他值是否超出规则的KEY//     *///    private static final String BIZ_BUDGET_OUT_RULES = "BIZ_BUDGET_OUT_RULES_QTBL";////    /**//     * 预算支出-比例前缀//     *///    private static final String BIZ_BUDGET_OUT_START_KEY = "BIZ_BUDGET_OUT_";////    /**//     * 预算支出-比例key值（对应数据中配置表）//     *///    private static final String[] BIZ_BUDGET_OUT_PROPORTION = {"GYYS", "GGYYS", "ZBLRJT", "QTBL"};////    /**//     * 全年支出预算提示//     *///    private static final String BIZ_BUDGET_OUT_MESSAGE = "BIZ_BUDGET_OUT_MESSAGE";////    /**//     * 全年总收入预算//     *///    private static final String BIZ_PERFORMANCE_TOTAL_IN = "MBHTSR";////    @Override//    public PerformanceVO getOrUpdate(Integer level, Long recordId, Integer currYear, PerformanceDTO budgetDTO) {//        // 相关配置//        Map<String, BigDecimal> formulaMap = Maps.newHashMap();//        for (String outKey : BIZ_BUDGET_OUT_PROPORTION) {//            String tmp = SysConfigUtils.getConfigCache(BIZ_BUDGET_OUT_START_KEY + outKey);//            if (StringUtils.isEmpty(tmp)) {//                throw new ServiceException("数据尚未初始化，请联系管理员");//            }//            formulaMap.put(outKey, new BigDecimal(tmp));//        }////        // 指定数据//        String rules = SysConfigUtils.getConfigCache(BIZ_BUDGET_OUT_RULES);//        List<BudgetOutRulesTemplate> bortList = JSON.parseArray(rules, BudgetOutRulesTemplate.class);//        if (StringUtils.isBlank(rules) || CollUtil.isEmpty(bortList)) {//            throw new ServiceException("数据尚未初始化，请联系管理员");//        }////        // 获取模板//        List<PerformanceTemplate> budgetTemplates = budgetManager.getTemplate(BIZ_BUDGET_OUT);////        // 查询对应的全年收入预算//        BudgetInYear budgetInYear = budgetInYearMapper.selectOne(Wrappers.<BudgetInYear>lambdaQuery()//                .eq(BudgetInYear::getLevel, level)//                .eq(BudgetInYear::getFieldYear, currYear)//                .eq(BudgetInYear::getRecordId, recordId)//                .eq(BudgetInYear::getFieldKey, BIZ_PERFORMANCE_TOTAL_IN).last(" limit 1 "));////        BigDecimal budgetInValue;//        if (null == budgetInYear || null == budgetInYear.getFieldValue() || (budgetInValue = budgetInYear.getFieldValue()).equals(BigDecimal.ZERO)) {//            throw new ServiceException("请先设置预算收入");//        }////        // 全年收入预算月数据//        List<BudgetInMonth> inMonthDatas = budgetInMonthMapper.selectList(Wrappers.<BudgetInMonth>lambdaQuery()//                .eq(BudgetInMonth::getRecordId, recordId)//                .eq(BudgetInMonth::getFieldYear, currYear)//                .eq(BudgetInMonth::getFieldKey, BIZ_PERFORMANCE_TOTAL_IN));////        Map<String, BudgetInMonth> inMonthsMap;//        if (null == inMonthDatas || CollUtil.isEmpty(inMonthDatas) || CollUtil.isEmpty(inMonthsMap = inMonthDatas.stream().collect(Collectors.toMap(PerformanceMonth::getFieldName, item -> item, (o1, o2) -> o1)))) {//            throw new ServiceException("请先设置预算收入");//        }////        // 年数据//        List<BudgetOutYear> dataList = budgetOutYearMapper.selectList(Wrappers.<BudgetOutYear>lambdaQuery()//                .eq(BudgetOutYear::getRecordId, recordId)//                .eq(BudgetOutYear::getFieldYear, currYear)//                .in(BudgetOutYear::getFieldKey, budgetTemplates.stream().map(PerformanceTemplate::getFieldKey).collect(Collectors.toList())));////        // 月数据//        List<BudgetOutMonth> monthDatas = budgetOutMonthMapper.selectList(Wrappers.<BudgetOutMonth>lambdaQuery()//                .eq(BudgetOutMonth::getRecordId, recordId)//                .eq(BudgetOutMonth::getFieldYear, currYear)//                .in(BudgetOutMonth::getFieldKey, budgetTemplates.stream().map(PerformanceTemplate::getFieldKey).collect(Collectors.toList())));////        PerformanceBO budgetBO = new PerformanceBO();//        budgetBO.setBudgetKey(BIZ_BUDGET_OUT);//        budgetBO.setYears(Collections.unmodifiableList(dataList));//        budgetBO.setMonths(Collections.unmodifiableList(monthDatas));//        budgetBO.setYMapper(budgetOutYearMapper);//        budgetBO.setMMapper(budgetOutMonthMapper);//        budgetBO.setLevel(level);//        budgetBO.setRecordId(recordId);//        budgetBO.setCurrYear(currYear);//        budgetBO.setBudgetDTO(budgetDTO);//        budgetBO.setModelName("BudgetOut");//        budgetBO.setBudgetYear(BudgetOutYear.class);//        budgetBO.setBudgetMonth(BudgetOutMonth.class);//        PerformanceVO performanceVO = budgetManager.getOrUpdate(budgetBO);////        // 设置值//        performanceVO.getBudgetDatas().stream().forEach(item -> {//            // 总部支出预算 or 总部利润计提//            if (item.getKey().equals(BIZ_PERFORMANCE_TOTAL_IN) || ArrayUtil.contains(BIZ_BUDGET_OUT_PROPORTION, item.getKey())) {//                if (item.getKey().equals(BIZ_PERFORMANCE_TOTAL_IN)) {//                    item.setValue(budgetInValue);//                } else {//                    item.setValue(budgetInValue.multiply(formulaMap.get(item.getKey())).divide(new BigDecimal(100)));//                }////                if (ArrayUtil.contains(new String[]{BIZ_PERFORMANCE_TOTAL_IN, BIZ_BUDGET_OUT_PROPORTION[2]}, item.getKey())) {//                    item.setReadonly(true);//                }////                // 总部月//                for (PerformanceValue performanceValue : item.getList().values()) {//                    BudgetInMonth budgetInMonth = inMonthsMap.get(performanceValue.getName());//                    if (null == budgetInMonth || null == budgetInMonth.getFieldValue() || budgetInMonth.getFieldValue().equals(BigDecimal.ZERO)) {//                        throw new ServiceException("请先设置" + performanceValue.getName() + "预算收入");//                    }////                    if (item.getKey().equals(BIZ_PERFORMANCE_TOTAL_IN)) {//                        performanceValue.setValue(budgetInMonth.getFieldValue());//                    } else {//                        item.setValue(budgetInValue.multiply(formulaMap.get(item.getKey())).divide(new BigDecimal(100)));//                        performanceValue.setValue(budgetInMonth.getFieldValue().multiply(formulaMap.get(item.getKey())).divide(new BigDecimal(100)));//                    }////                    if (ArrayUtil.contains(new String[]{BIZ_PERFORMANCE_TOTAL_IN, BIZ_BUDGET_OUT_PROPORTION[2]}, item.getKey())) {//                        performanceValue.setReadonly(true);//                    }////                }//            }////            for (String key : formulaMap.keySet()) {//                if (item.getKey().equals(key)) {//                    item.setDefaultValue(budgetInValue.multiply(formulaMap.get(key)).divide(new BigDecimal(100)));//                }////                // 备注//                if (StringUtils.isNotEmpty(item.getDesc())) {//                    item.setDesc(item.getDesc().replace("{" + key + "}", String.valueOf(formulaMap.get(key))));//                }//            }//        });////        // 设置 规则计算提示//        for (BudgetOutRulesTemplate bort : bortList) {//            BigDecimal bigDecimal = formulaMap.get(BIZ_BUDGET_OUT_PROPORTION[3]);//            if (null != bigDecimal && !bigDecimal.equals(BigDecimal.ZERO)) {//                bort.setValueLeft(budgetInValue.multiply(bigDecimal).divide(new BigDecimal(100)));//                bort.setWraningMsg(bort.getWraningMsg().replace("{" + BIZ_BUDGET_OUT_START_KEY + BIZ_BUDGET_OUT_PROPORTION[3] + "}", String.valueOf(bigDecimal)));//            }//        }////        performanceVO.setRules(bortList);//        return performanceVO;//    }////    @Override//    public PerformanceVO groupData(List<Long> ids, Integer currYear, String budgetKey) {//        List<PerformanceList> budgetInLists = budgetMapper.groupOutData(ids, currYear);//        return budgetManager.groupData(currYear, budgetKey, budgetInLists);//    }////    @Override//    public String note() {//        String messge = SysConfigUtils.getConfigCache(BIZ_BUDGET_OUT_MESSAGE);//        if (StringUtils.isNotEmpty(messge)) {//            for (String outKey : BIZ_BUDGET_OUT_PROPORTION) {//                String tmp = SysConfigUtils.getConfigCache(BIZ_BUDGET_OUT_START_KEY + outKey);//                if (StringUtils.isNotEmpty(tmp)) {//                    messge = messge.replace("{" + BIZ_BUDGET_OUT_START_KEY + outKey + "}", tmp);//                }//            }//        }////        return messge;//    }////}